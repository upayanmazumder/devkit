name: DevKit CI & Publish

on:
  push:
    tags:
      - "v*.*.*" # Trigger on version tags like v1.0.0
  pull_request:
    branches: [main]

jobs:
  # -------------------
  # 1) Test PowerShell module
  # -------------------
  pwsh-test:
    name: Test PowerShell Module
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Load Install-AllPackages script and test
        shell: pwsh
        run: |
          # Dot-source the script to load functions
          . ./pwsh/Install-AllPackages.ps1
          Write-Host "Loaded Install-AllPackages.ps1"
          # Run a dry-run of the main function
          Install-AllPackages -Depth 1

  # -------------------
  # 2) Test Bash scripts
  # -------------------
  bash-test:
    name: Test Bash Scripts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Make scripts executable
        run: chmod +x bash/*.sh

      - name: Dry-run install-all.sh
        run: bash/install-all.sh

  # -------------------
  # 3) Publish PowerShell module to PSGallery
  # -------------------
  publish-pwsh:
    name: Publish PowerShell Module
    runs-on: windows-latest
    needs: [pwsh-test]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install PowerShellGet module
        shell: pwsh
        run: Install-Module -Name PowerShellGet -Force -SkipPublisherCheck

      - name: Publish DevKit to PSGallery
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          # Dot-source Install-AllPackages if needed
          . ./pwsh/Install-AllPackages.ps1
          # Publish the module pointing directly to the .psd1 manifest
          Publish-Module -Path ./pwsh/DevKit.psd1 -NuGetApiKey $env:PSGALLERY_API_KEY -Verbose

  # -------------------
  # 4) Publish Bash scripts to GitHub release
  # -------------------
  release-bash:
    name: Publish Bash Scripts
    runs-on: ubuntu-latest
    needs: [bash-test, publish-pwsh]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Zip Bash Scripts
        run: |
          mkdir -p release
          zip -r release/devkit-bash.zip bash/

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Bash Artifact
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: release/devkit-bash.zip
          asset_name: devkit-bash.zip
          asset_content_type: application/zip
